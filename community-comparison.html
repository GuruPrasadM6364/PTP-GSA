<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Data Tracking — Renewable Energy Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { text-align: center; padding: 2.5rem 1rem; }
    .container { max-width: 720px; margin: 1.5rem auto; }
    h1 { color: #2e7d32; margin-bottom: 0.5rem; }
    p.lead { color: #666; font-size: 16px; margin-bottom: 1rem; }
    .card { background:#fff; border-radius:10px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:1rem; text-align:left; }
    .metric { font-size:1.2rem; font-weight:700; color:#2e7d32; }
    .muted { color:#666; font-size:0.95rem; }
    .btn-large { display: inline-block; padding: 0.75rem 1.25rem; background: #388e3c; color: white; text-decoration: none; border-radius: 8px; font-size: 15px; font-weight: bold; }
    .btn-large:hover { background: #2e7d32; }
    .row { display:flex; gap:0.8rem; flex-wrap:wrap; align-items:center; }
    input[type="number"] { padding:0.5rem; border-radius:6px; border:1px solid #ddd; width:140px; }
  </style>
</head>
<body>
  <nav><span style="font-weight:bold;">Live Data Tracking</span></nav>

  <div class="container">
    <h1>⚡ Carbon Estimate for Your Location</h1>
    <p class="lead">We detect your location (browser or IP) and provide a quick CO₂ estimate per kWh and typical household emissions.</p>

    <div class="card" id="locationCard">
      <div id="locInfo" class="muted">Detecting location…</div>
    </div>

    <div class="card">
      <h3>Estimated grid intensity</h3>
      <div id="efValue" class="metric">— kg CO₂ / kWh</div>
      <div id="hhEstimate" class="muted" style="margin-top:0.4rem;">— typical household annual consumption / emissions</div>
    </div>

    <div class="card">
      <h3>Quick calculator</h3>
      <div class="row">
        <label class="muted">Monthly electricity (kWh):</label>
        <input id="monthlyKwh" type="number" min="0" step="1" value="200" />
        <button class="btn-large" id="calcBtn">Calculate</button>
      </div>
      <div id="calcResult" style="margin-top:0.75rem;" class="muted"></div>
    </div>

    <p style="margin-top:0.5rem;"><a class="btn-large" href="landing.html">← Back to Home</a></p>
  </div>

  <script>
    async function loadEmissions() {
      // Try browser geolocation first
      let lat=null, lon=null;
      if (navigator.geolocation) {
        try {
          const p = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout:8000 }));
          lat = p.coords.latitude; lon = p.coords.longitude;
        } catch (e) {
          // ignore — server will use IP fallback
        }
      }
      const q = (lat !== null && lon !== null) ? `?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}` : '';
      try {
        const resp = await fetch(`/api/emissions${q}`);
        if (!resp.ok) throw new Error('backend error');
        const data = await resp.json();
        renderData(data);
      } catch (err) {
        document.getElementById('locInfo').textContent = 'Failed to fetch emission data. See console for details.';
        console.error(err);
      }
    }

    function renderData(d) {
      const det = d.detected || {};
      const locInfo = document.getElementById('locInfo');
      locInfo.innerHTML = `<div><strong>${escapeHtml(det.city || 'Unknown location')}</strong> ${det.region ? '· ' + escapeHtml(det.region) : ''} ${det.country ? '· ' + escapeHtml(det.country) : ''}</div>
                           <div class="muted">Lat: ${Number(det.latitude).toFixed(4)} · Lon: ${Number(det.longitude).toFixed(4)} · source: ${escapeHtml(det.source || 'ip')}</div>`;

      const ef = Number(d.emission_factor_kg_per_kwh) || 0;
      document.getElementById('efValue').textContent = ef.toFixed(3) + ' kg CO₂ / kWh';
      const hh_kwh = Number(d.typical_household_annual_kwh) || 0;
      const hh_co2 = Number(d.typical_household_annual_co2_kg) || 0;
      document.getElementById('hhEstimate').textContent = `${hh_kwh.toLocaleString()} kWh / yr → ${hh_co2.toLocaleString()} kg CO₂ / yr (${d.note || ''})`;

      // set calculator default
      document.getElementById('monthlyKwh').value = Math.round(hh_kwh/12) || 200;
      document.getElementById('calcResult').textContent = '';
      document.getElementById('calcBtn').onclick = () => {
        const monthly = Number(document.getElementById('monthlyKwh').value) || 0;
        const annual = monthly * 12;
        const co2kg = annual * ef;
        document.getElementById('calcResult').innerHTML = `<strong>${annual.toLocaleString()} kWh / yr</strong> → <strong>${co2kg.toFixed(1)} kg CO₂ / yr</strong>`;
      };
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    loadEmissions();
  </script>
</body>
</html>